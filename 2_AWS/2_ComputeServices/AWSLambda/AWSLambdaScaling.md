# :star: Scaling consideration - Concurrency

| Concurrency Config                                                                                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                  |
|----------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Unreserved concurrency                                                                                         | The amount of concurrency that is not allocated to any specific set of functions. The minimum is 100 unreserved concurrency. This allows functions that do not have any provisioned concurrency to still be able to run. If you provision all your concurrency to one or two functions, no concurrency is left for any other function. Having at least 100 available allows all your functions to run when they are invoked. |
| [Provisioned concurrency](https://docs.aws.amazon.com/lambda/latest/dg/provisioned-concurrency.html)           | Provisioned concurrency initializes a requested number of execution environments so that they are prepared to respond immediately to your function's invocations. <br/>- Note that configuring provisioned concurrency incurs charges to your AWS account.                                                                                                                                                                   |
| [Reserved concurrency](https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html)            | Guarantees the maximum number of concurrent instances for the function. <br/>- When a function has reserved concurrency, no other function can use that concurrency. <br/>- No charge is incurred for configuring reserved concurrency for a function.<br/>- Address invocation errors.                                                                                                                                      |
| [Concurrency limit](https://aws.amazon.com/premiumsupport/knowledge-center/lambda-concurrency-limit-increase/) | If we set it to 0, the lambda would stop processing any events. It achieves following<br/>- Limit costs<br/>- Regulate how long it takes you to process a batch of events.<br/>- Match it with a downstream resource that cannot scale as quickly as Lambda, for example - [Support 3rd-party API rate limiting](https://aws.amazon.com/blogs/architecture/rate-limiting-strategies-for-serverless-applications/)            |

# Per-shard Concurrency Limit
- Streaming event sources (like [Amazon Kinesis Data Streams](../../4_MessageBrokerServices/AmazonKinesis/Readme.md)) measure concurrency by the number of shards. There is a limit of one concurrent Lambda invocation per shard.
- For most streaming services, Lambda will continue to retry a record, until the record is successfully processed, or the retention period for the record expires. 
- That means that if one record in a batch fails, the whole batch of records and by extension the shard serving that batch is held up until the retention period expires. 
- This is why itâ€™s important to include code to handle a partial failure or poison message scenario, so you can get past a bad record.

# Best practice: Minimize cold start times

| Practice                                                                                                        |
|-----------------------------------------------------------------------------------------------------------------|
| After optimizing your function, another way to minimize cold starts is to use provisioned concurrency.          |
| Provisioned concurrency is a Lambda feature that prepares concurrent execution environments before invocations. |

# Best practice: Write functions to take advantage of warm starts

| Practice                                              | Remarks                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|-------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Database connection best practices                    | - Initialize one connection outside the handler and check for connection.<br/>- Use database TTL to clean up connections.<br/>- Although you can use [concurrency limits]() to limit database connections, this increases account management complexity and is difficult to estimate. Hence the best practice is to implement an [external mechanism for managing the connections](https://docs.aws.amazon.com/lambda/latest/dg/configuration-database.html). |
| Store and reference dependencies locally.             |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Limit re-initialization of variables.                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Add code to check for and reuse existing connections. |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Use tmp space as transient cache.                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Check that background processes have completed.       |                                                                                                                                                                                                                                                                                                                                                                                                                                                          |